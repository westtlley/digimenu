import{r as o,j as e,B as A,P as E,u as q,d as S,L as V,z as M}from"./main-5wCJ0shd.js";import{u as $}from"./useQuery-TBRlwA9F.js";import{u as K}from"./useMutation-CfjUJVgq.js";import{u as Q}from"./useSlugContext-DE6V1uue.js";import{u as G}from"./usePermission-CvwVjOfT.js";import{B as I}from"./badge-tC6tpDVj.js";import{C as H}from"./card-co3zywKC.js";import{C as L}from"./chef-hat-Tma-MV-q.js";import{B as Y}from"./bell-BP42pcPs.js";import{d as F,a as J,M as W,T as X}from"./differenceInMinutes-Dz30xM9P.js";import{F as Z}from"./filter-BiXx4-4p.js";import{C as ee}from"./clock-8p17jiPd.js";import{A as U}from"./index-BrRbWNqX.js";import{S as se}from"./shopping-bag-Bd6hIey6.js";import{T as te}from"./truck-BfUKktyx.js";import{m as B}from"./proxy-CaN4jGBq.js";import{U as ae}from"./user-SYMNLJbz.js";import{M as ie}from"./map-pin-Cc9ILfAa.js";import{C as ne}from"./circle-check-big-C21gM6y_.js";import{C as re}from"./circle-alert-CSoTi2zi.js";import{L as R}from"./log-out-DCopNCEG.js";import"./base44Client-BjweZdup.js";import"./PlanPresets-DhKoJrBx.js";import"./constants-CG7Neo-X.js";const ce={new:"bg-red-500",accepted:"bg-yellow-500",preparing:"bg-orange-500",ready:"bg-green-500"},le={new:"Novo",accepted:"Aceito",preparing:"Em Preparo",ready:"Pronto"},oe={delivery:te,pickup:se,dine_in:E};function de({order:s,prepTime:x}){const[d,j]=o.useState(0),[f,y]=o.useState(!1);if(o.useEffect(()=>{if(!s.accepted_at||!x)return;const l=setInterval(()=>{const h=F(new Date,new Date(s.accepted_at));j(h),y(h>x)},1e3);return()=>clearInterval(l)},[s.accepted_at,x]),!s.accepted_at||!x)return null;const c=x-d,u=c<=5&&c>0,p=c<=0;return e.jsxs("div",{className:`flex items-center gap-1 text-xs font-bold ${p?"text-red-600":u?"text-orange-600":"text-gray-600"}`,children:[e.jsx(X,{className:"w-3 h-3"}),p?e.jsxs("span",{className:"animate-pulse",children:["ATRASADO ",Math.abs(c),"min"]}):u?e.jsxs("span",{className:"animate-pulse",children:[c,"min"]}):e.jsxs("span",{children:[c,"min"]})]})}function me({order:s,onStatusChange:x,prepTime:d}){const[j,f]=o.useState(!1),y=oe[s.delivery_method]||E,c=s.accepted_at?F(new Date,new Date(s.accepted_at)):0,u=d&&c>d,p=d&&d-c<=5&&d-c>0;return e.jsx(B.div,{layout:!0,initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},className:`relative ${u?"ring-2 ring-red-500":p?"ring-2 ring-orange-500":""}`,children:e.jsxs(H,{className:`overflow-hidden transition-all ${u?"bg-red-50 dark:bg-red-900/20":p?"bg-orange-50 dark:bg-orange-900/20":"bg-white dark:bg-gray-800"}`,children:[e.jsx("div",{className:`p-3 ${ce[s.status]} text-white`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-bold text-lg",children:["#",s.order_code||s.id.slice(-6)]})]}),e.jsx(I,{variant:"secondary",className:"bg-white/20 text-white border-0",children:le[s.status]})]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm flex-wrap",children:[e.jsx(y,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600 dark:text-gray-400 capitalize",children:s.delivery_method==="delivery"?"Entrega":s.delivery_method==="pickup"?"Retirada":(s.delivery_method==="dine_in","Presencial")}),s.source&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-300",children:"•"}),e.jsx(I,{variant:"outline",className:"text-xs",children:s.source==="comanda"?"Comanda":s.source==="pdv"?"PDV":"Online"})]}),s.table_name&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-300",children:"•"}),e.jsxs("span",{className:"text-gray-600 dark:text-gray-400",children:["Mesa: ",s.table_name]})]}),s.customer_name&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-300",children:"•"}),e.jsx(ae,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:s.customer_name})]})]}),s.status!=="new"&&s.accepted_at&&e.jsx(de,{order:s,prepTime:d||s.prep_time}),e.jsxs("div",{className:"space-y-1",children:[s.items?.slice(0,3).map((l,h)=>e.jsx("div",{className:"flex items-start justify-between text-sm",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("span",{className:"font-medium text-gray-900 dark:text-white",children:[l.quantity,"x ",l.name]}),l.observations&&e.jsxs("p",{className:"text-xs text-gray-500 italic mt-0.5",children:["Obs: ",l.observations]}),l.complements&&l.complements.length>0&&e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:l.complements.map(w=>w.name).join(", ")})]})},h)),s.items?.length>3&&e.jsxs("button",{onClick:()=>f(!j),className:"text-xs text-orange-600 hover:text-orange-700 font-medium",children:["+",s.items.length-3," itens"]})]}),e.jsx(U,{children:j&&e.jsx(B.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"space-y-1 pt-2 border-t",children:s.items?.slice(3).map((l,h)=>e.jsx("div",{className:"flex items-start justify-between text-sm",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("span",{className:"font-medium text-gray-900 dark:text-white",children:[l.quantity,"x ",l.name]}),l.observations&&e.jsxs("p",{className:"text-xs text-gray-500 italic mt-0.5",children:["Obs: ",l.observations]})]})},h))})}),s.observations&&e.jsx("div",{className:"pt-2 border-t",children:e.jsxs("p",{className:"text-xs text-gray-600 dark:text-gray-400 italic",children:[e.jsx("strong",{children:"Pedido:"})," ",s.observations]})}),s.delivery_method==="delivery"&&s.delivery_address&&e.jsxs("div",{className:"pt-2 border-t flex items-start gap-2 text-xs",children:[e.jsx(ie,{className:"w-3 h-3 text-gray-500 mt-0.5"}),e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:s.delivery_address})]}),e.jsxs("div",{className:"flex gap-2 pt-2 border-t",children:[s.status==="new"&&e.jsxs(A,{size:"sm",className:"flex-1 bg-green-600 hover:bg-green-700",onClick:()=>x(s,"accepted"),children:[e.jsx(ne,{className:"w-4 h-4 mr-1"}),"Aceitar"]}),s.status==="accepted"&&e.jsxs(A,{size:"sm",className:"flex-1 bg-orange-600 hover:bg-orange-700",onClick:()=>x(s,"preparing"),children:[e.jsx(L,{className:"w-4 h-4 mr-1"}),"Iniciar Preparo"]}),s.status==="preparing"&&e.jsxs(A,{size:"sm",className:"flex-1 bg-green-600 hover:bg-green-700",onClick:()=>x(s,"ready"),children:[e.jsx(E,{className:"w-4 h-4 mr-1"}),"Pronto"]})]})]})]})})}function xe({orders:s=[],onStatusChange:x,prepTime:d=30,isLoading:j=!1}){const[f,y]=o.useState("all"),[c,u]=o.useState("all"),[p,l]=o.useState(!1),[h,w]=o.useState(!0),[O,C]=o.useState(0),D=o.useMemo(()=>{let r=s;return f!=="all"&&(r=r.filter(a=>a.status===f)),c!=="all"&&(r=r.filter(a=>a.delivery_method===c)),r.sort((a,i)=>{if(a.status==="new"&&i.status!=="new")return-1;if(i.status==="new"&&a.status!=="new")return 1;if(a.status==="new"&&i.status==="new"){const b=a.created_date||a.created_at?new Date(a.created_date||a.created_at).getTime():0,_=i.created_date||i.created_at?new Date(i.created_date||i.created_at).getTime():0;return b-_}const g=a.prep_time||d,t=i.prep_time||d,m=a.accepted_at?new Date(a.accepted_at).getTime():0,n=i.accepted_at?new Date(i.accepted_at).getTime():0;if(m>0&&n>0){const b=new Date().getTime(),_=(b-m)/(1e3*60),T=(b-n)/(1e3*60),z=g-_,v=t-T;return z<0&&v>=0?-1:v<0&&z>=0?1:(z<0&&v<0,z-v)}const N=a.created_date||a.created_at?new Date(a.created_date||a.created_at).getTime():0,P=i.created_date||i.created_at?new Date(i.created_date||i.created_at).getTime():0;return N-P})},[s,f,c]),k=o.useMemo(()=>{const r=s.filter(n=>n.status==="new").length,a=s.filter(n=>n.status==="accepted").length,i=s.filter(n=>n.status==="preparing").length,g=s.filter(n=>n.status==="ready").length,t=s.filter(n=>n.ready_at&&n.accepted_at),m=t.length>0?t.reduce((n,N)=>{const P=F(new Date(N.ready_at),new Date(N.accepted_at));return n+P},0)/t.length:0;return{new:r,accepted:a,preparing:i,ready:g,total:s.length,avgPrepTime:Math.round(m)}},[s]);return o.useEffect(()=>{const r=s.filter(a=>a.status==="new").length;if(r>O&&h){const a=new Audio("/sounds/notification.mp3");a.volume=.5,a.play().catch(()=>{if(window.AudioContext||window.webkitAudioContext){const i=new(window.AudioContext||window.webkitAudioContext),g=i.createOscillator(),t=i.createGain();g.connect(t),t.connect(i.destination),g.frequency.value=800,g.type="sine",t.gain.setValueAtTime(.3,i.currentTime),t.gain.exponentialRampToValueAtTime(.01,i.currentTime+.5),g.start(i.currentTime),g.stop(i.currentTime+.5)}})}C(r)},[s.length,h,O]),o.useEffect(()=>{p?document.documentElement.requestFullscreen?.():document.exitFullscreen?.()},[p]),e.jsxs("div",{className:`${p?"fixed inset-0 z-50":""} bg-gray-100 dark:bg-gray-900`,children:[e.jsx("div",{className:"bg-orange-600 text-white shadow-lg sticky top-0 z-10",children:e.jsxs("div",{className:"px-4 py-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"w-6 h-6"}),e.jsx("h1",{className:"font-bold text-xl",children:"Kitchen Display"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{variant:"ghost",size:"sm",className:"text-white hover:bg-orange-500",onClick:()=>w(!h),children:e.jsx(Y,{className:`w-4 h-4 ${h?"":"opacity-50"}`})}),e.jsx(A,{variant:"ghost",size:"sm",className:"text-white hover:bg-orange-500",onClick:()=>l(!p),children:p?e.jsx(J,{className:"w-4 h-4"}):e.jsx(W,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-5 gap-2 text-center",children:[e.jsxs("div",{className:"bg-white/20 rounded p-2",children:[e.jsx("div",{className:"text-2xl font-bold",children:k.new}),e.jsx("div",{className:"text-xs opacity-90",children:"Novos"})]}),e.jsxs("div",{className:"bg-white/20 rounded p-2",children:[e.jsx("div",{className:"text-2xl font-bold",children:k.accepted}),e.jsx("div",{className:"text-xs opacity-90",children:"Aceitos"})]}),e.jsxs("div",{className:"bg-white/20 rounded p-2",children:[e.jsx("div",{className:"text-2xl font-bold",children:k.preparing}),e.jsx("div",{className:"text-xs opacity-90",children:"Preparando"})]}),e.jsxs("div",{className:"bg-white/20 rounded p-2",children:[e.jsx("div",{className:"text-2xl font-bold",children:k.ready}),e.jsx("div",{className:"text-xs opacity-90",children:"Prontos"})]}),e.jsxs("div",{className:"bg-white/20 rounded p-2",children:[e.jsx("div",{className:"text-2xl font-bold",children:k.avgPrepTime}),e.jsx("div",{className:"text-xs opacity-90",children:"Média (min)"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-3",children:[e.jsx(Z,{className:"w-4 h-4"}),e.jsxs("select",{value:f,onChange:r=>y(r.target.value),className:"bg-white/20 text-white border-white/30 rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"all",children:"Todos os Status"}),e.jsx("option",{value:"new",children:"Novos"}),e.jsx("option",{value:"accepted",children:"Aceitos"}),e.jsx("option",{value:"preparing",children:"Em Preparo"}),e.jsx("option",{value:"ready",children:"Prontos"})]}),e.jsxs("select",{value:c,onChange:r=>u(r.target.value),className:"bg-white/20 text-white border-white/30 rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"all",children:"Todos os Tipos"}),e.jsx("option",{value:"delivery",children:"Entrega"}),e.jsx("option",{value:"pickup",children:"Retirada"}),e.jsx("option",{value:"dine_in",children:"Presencial"})]})]})]})}),e.jsx("div",{className:"p-4",children:j?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(ee,{className:"w-8 h-8 animate-spin text-orange-500"})}):D.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(E,{className:"w-16 h-16 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Nenhum pedido encontrado"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:e.jsx(U,{children:D.map(r=>e.jsx(me,{order:r,onStatusChange:x,prepTime:d||r.prep_time},r.id))})})})]})}function Me(){const[s,x]=o.useState(null),[d,j]=o.useState(!0),[f,y]=o.useState(!1),[c,u]=o.useState({loading:!0,hasAccess:!1}),p=q(),{subscriberEmail:l,inSlugContext:h}=Q(),{subscriberData:w,isMaster:O}=G(),C=h&&s?.is_master&&l?l:void 0;o.useEffect(()=>{(async()=>{try{const t=await S.auth.me();if(x(t),!t){S.auth.redirectToLogin("/Cozinha");return}const m=t?.subscriber_email&&(t?.email||"").toLowerCase().trim()===(t?.subscriber_email||"").toLowerCase().trim(),n=t?.profile_roles?.length?t.profile_roles:t?.profile_role?[t.profile_role]:[],N=n.includes("gerente"),P=t?.profile_role==="cozinha"||n.includes("cozinha"),b=!t.subscriber_email||t.email&&t.subscriber_email&&t.email.toLowerCase().trim()===t.subscriber_email.toLowerCase().trim(),_=P||t?.is_master===!0||m||N||b;if(console.log("[Cozinha] Verificando acesso:",{email:t.email,subscriber_email:t.subscriber_email,profile_role:t.profile_role,profile_roles:t.profile_roles,is_master:t.is_master,isAssinante:m,isGerente:N,isCozinha:P,isOwner:b,hasProfileAccess:_,subscriberData:w}),y(_),!_){j(!1);return}const T=(w?.plan||"basic").toString().toLowerCase();if(T==="basic")console.log("[Cozinha] Plano básico - App Cozinha não disponível"),u({loading:!1,hasAccess:!1}),y(!1);else if(_&&!t?.is_master&&!m&&!N&&!b){const v=T==="pro"||T==="ultra";console.log("[Cozinha] Verificando plano para funcionário:",{plan:T,hasPlanAccess:v}),u({loading:!1,hasAccess:v}),v||y(!1)}else u({loading:!1,hasAccess:!0})}catch{S.auth.redirectToLogin("/Cozinha")}finally{j(!1)}})()},[w]);const{data:D=[],isLoading:k}=$({queryKey:["cozinhaOrders",C??"me"],queryFn:()=>S.entities.Order.list("-created_date",C?{as_subscriber:C}:{}),enabled:f,refetchInterval:8e3}),r=K({mutationFn:({id:t,updates:m})=>S.entities.Order.update(t,m,C?{as_subscriber:C}:{}),onSuccess:()=>{p.invalidateQueries({queryKey:["cozinhaOrders"]}),M.success("Status atualizado")},onError:t=>M.error(t?.message||"Erro ao atualizar")}),a=Array.isArray(D)?D.filter(t=>["new","accepted","preparing","ready"].includes(t.status)):[],i=30,g=(t,m)=>{const n={};m==="accepted"?(n.status="accepted",n.accepted_at=new Date().toISOString(),n.prep_time=t.prep_time||i):m==="preparing"?(n.status="preparing",n.preparing_at=new Date().toISOString()):m==="ready"&&(n.status="ready",n.ready_at=new Date().toISOString()),r.mutate({id:t.id,updates:n})};return d?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-100 dark:bg-gray-900",children:e.jsx(V,{className:"w-8 h-8 animate-spin text-orange-500"})}):!f||c.loading===!1&&!c.hasAccess&&!O?e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4 bg-gray-100 dark:bg-gray-900",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 max-w-md text-center",children:[e.jsx(L,{className:"w-12 h-12 text-orange-500 mx-auto mb-3"}),e.jsx("h2",{className:"text-lg font-bold text-gray-900 dark:text-white",children:"Acesso restrito"}),!c.hasAccess&&!O?e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"w-8 h-8 text-orange-500 mx-auto mb-3"}),e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 mt-2",children:["O Kitchen Display System está disponível apenas nos planos ",e.jsx("strong",{children:"PRO"})," e ",e.jsx("strong",{children:"ULTRA"}),"."]}),e.jsxs("p",{className:"text-sm text-gray-400 dark:text-gray-500 mt-2",children:["Seu plano atual: ",e.jsx("strong",{children:(w?.plan||"Básico").toUpperCase()})]})]}):e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-2",children:"Esta tela é apenas para o perfil Cozinha."}),e.jsxs(A,{onClick:()=>S.auth.logout(),className:"mt-4",variant:"outline",children:[e.jsx(R,{className:"w-4 h-4 mr-2"}),"Sair"]})]})}):e.jsxs("div",{className:"min-h-screen min-h-screen-mobile",children:[e.jsx(xe,{orders:a,onStatusChange:g,prepTime:i,isLoading:k}),e.jsx("div",{className:"fixed bottom-4 right-4 z-50",children:e.jsxs(A,{variant:"outline",size:"sm",className:"bg-white dark:bg-gray-800 shadow-lg",onClick:()=>S.auth.logout(),children:[e.jsx(R,{className:"w-4 h-4 mr-2"}),"Sair"]})})]})}export{Me as default};
