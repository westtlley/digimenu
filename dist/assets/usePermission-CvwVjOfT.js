import{r as b,y as d}from"./main-5wCJ0shd.js";import{b as E}from"./base44Client-BjweZdup.js";import{m as D}from"./PlanPresets-DhKoJrBx.js";import{u as J}from"./useSlugContext-DE6V1uue.js";function R(o,a){return o?.is_master===!0?{type:"slug",value:o?.slug||null}:a?.email?{type:"subscriber",value:a.email}:{type:"subscriber",value:o?.email||null}}function L(o,a,_={}){const c=o?.is_master===!0,m=R(o,a);return{user:o,menuContext:m,permissions:_,isMaster:c,subscriberData:c?null:a}}let x=null;function z(){const[o,a]=b.useState({}),[_,c]=b.useState(!0),[m,h]=b.useState(null),[N,f]=b.useState(null),[v,p]=b.useState(null),{subscriberEmail:y,inSlugContext:P}=J(),w=b.useCallback(async()=>{let e=null;if(x)try{e=await x}finally{x=null}else{x=(async()=>{let t=null;for(let r=1;r<=3;r++)try{t=await E.get("/user/context",{_t:Date.now()});break}catch(n){if((n?.message?.includes("CONNECTION")||n?.message?.includes("Failed to fetch")||n?.message?.includes("NetworkError")||n?.name==="TypeError")&&r<3)await new Promise(u=>setTimeout(u,2e3));else throw n}return t})();try{e=await x}finally{x=null}}try{try{if(!e||!e.user){d.permission.warn("⚠️ [usePermission] Contexto não retornado pelo backend"),a({}),h(null),f(null),p(null),c(!1);return}h(e.user);let s=e.permissions;if(typeof s=="string")try{s=JSON.parse(s)}catch{s={}}(!s||typeof s!="object")&&(s={});const t=(e.subscriberData?.plan||"basic").toString().toLowerCase().trim();e.user?.is_master!==!0&&Object.keys(s).length===0&&t&&t!=="custom"&&(s=D(s,t)),a(s);let r=e.subscriberData?{...e.subscriberData,plan:t,status:e.subscriberData.status||"active"}:null;if(P&&y&&!e.user.is_master&&y.toLowerCase()!==(e.user.email||"").toLowerCase()&&y.toLowerCase()!==(e.user.subscriber_email||"").toLowerCase())try{const u=await E.functions.invoke("checkSubscriptionStatus",{user_email:y});if(u.data?.subscriber){const g=u.data.subscriber,C=(g.plan||"basic").toString().toLowerCase().trim();r={...g,plan:C,status:g.status||"active"};let l=g.permissions||{};if(typeof l=="string")try{l=JSON.parse(l)}catch{l={}}(!l||typeof l!="object")&&(l={}),Object.keys(l).length===0&&C&&C!=="custom"&&(l=D(l,C)),a(l)}}catch(u){d.permission.warn("⚠️ [usePermission] Erro ao buscar dados do assinante do slug:",u)}f(r);let n=e.menuContext;P&&y&&!e.user.is_master&&(n={type:"subscriber",value:y});const i={user:e.user,menuContext:n,permissions:s,isMaster:e.user.is_master===!0,subscriberData:e.user.is_master?null:r};p(i);try{sessionStorage.setItem("userContext",JSON.stringify({subscriberData:r,menuContext:n}))}catch{}}catch{d.permission.warn("⚠️ [usePermission] Endpoint /user/context não disponível, usando fallback");const t=await E.auth.me();if(!t){d.permission.warn("⚠️ [usePermission] Usuário não encontrado"),a({}),h(null),f(null),p(null),c(!1);return}if(h(t),t.is_master===!0){const r={},n={email:t.email,plan:"master",status:"active",permissions:{}};a(r),f(n);const i=L(t,n,r);p(i)}else{let r;try{r=await E.functions.invoke("checkSubscriptionStatus",{user_email:t.email})}catch(n){d.permission.warn("⚠️ [usePermission] checkSubscriptionStatus falhou, usando contexto mínimo:",n?.message),r=null}if(r?.data?.subscriber){const n=r.data.subscriber;let i=n.permissions||{};if(typeof i=="string")try{i=JSON.parse(i)}catch{i={}}(!i||typeof i!="object")&&(i={});const u=(n.plan||"basic").toString().toLowerCase().trim();Object.keys(i).length===0&&u&&u!=="custom"&&(i=D(i,u)),a(i),f(n);const g=L(t,n,i);p(g)}else{const i={email:t.subscriber_email||t.email,plan:"basic",status:"active",permissions:{}};a({}),f(i);const u=L(t,i,{});p(u),d.permission.warn("⚠️ [usePermission] Usando contexto mínimo (checkSubscriptionStatus indisponível)")}}}}catch(s){d.permission.error("Error loading permissions:",s),a({}),f(null),p(null),c(!1)}finally{c(!1)}},[P,y]);b.useEffect(()=>{w();const e=setInterval(w,300*1e3),s=()=>w();window.addEventListener("focus",s);const t=setTimeout(()=>{c(r=>r&&!1)},12e3);return()=>{clearInterval(e),window.removeEventListener("focus",s),clearTimeout(t)}},[w]);const k=m?.is_master===!0,O=e=>{if(k||(m?.profile_roles?.length?m.profile_roles:m?.profile_role?[m.profile_role]:[]).includes("gerente"))return!0;if(o&&typeof o=="object"){const r=o[e];if(Array.isArray(r)&&r.length>0)return!0}return!1},S=(e,s)=>{if(k)return!0;if(!o||typeof o!="object")return!1;const t=o[e];return Array.isArray(t)&&t.includes(s)},j=e=>S(e,"create"),U=e=>S(e,"update"),M=e=>S(e,"delete"),T=e=>S(e,"view"),A=()=>{c(!0),w()},I=b.useMemo(()=>v?.menuContext||null,[v?.menuContext?.type,v?.menuContext?.value]);return{permissions:o,loading:_,user:m,subscriberData:N,isMaster:k,hasModuleAccess:O,hasPermission:S,canCreate:j,canUpdate:U,canDelete:M,canView:T,refresh:A,userContext:v,menuContext:I}}export{z as u};
