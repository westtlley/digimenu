import{r as g,w as a}from"./main-AonIQAES.js";import{b as P}from"./base44Client-DnnNNlVu.js";import{u as N}from"./useSlugContext-CNsGQFhv.js";function T(n,i){return n?.is_master===!0?{type:"slug",value:n?.slug||null}:i?.email?{type:"subscriber",value:i.email}:{type:"subscriber",value:n?.email||null}}function _(n,i,v={}){const m=n?.is_master===!0,S=T(n,i);return{user:n,menuContext:S,permissions:v,isMaster:m,subscriberData:m?null:i}}function $(){const[n,i]=g.useState({}),[v,m]=g.useState(!0),[S,y]=g.useState(null),[D,f]=g.useState(null),[k,d]=g.useState(null),{subscriberEmail:l,inSlugContext:h}=N(),x=g.useCallback(async()=>{try{a.permission.log("ðŸ”„ [usePermission] Carregando contexto do usuÃ¡rio...");let e=null;const c=3;for(let t=1;t<=c;t++)try{e=await P.get("/user/context",{_t:Date.now()});break}catch(s){if((s?.message?.includes("CONNECTION")||s?.message?.includes("Failed to fetch")||s?.message?.includes("NetworkError")||s?.name==="TypeError")&&t<c)a.permission.warn(`âš ï¸ [usePermission] Tentativa ${t}/${c} falhou (rede), aguardando 2s...`),await new Promise(o=>setTimeout(o,2e3));else throw s}try{if(!e||!e.user){a.permission.warn("âš ï¸ [usePermission] Contexto nÃ£o retornado pelo backend"),i({}),y(null),f(null),d(null),m(!1);return}a.permission.log("âœ… [usePermission] Contexto recebido do backend:",{is_master:e.user.is_master,menuContext:e.menuContext,subscriberData:e.subscriberData,plan:e.subscriberData?.plan}),y(e.user);let t=e.permissions;if(typeof t=="string")try{t=JSON.parse(t)}catch{t={}}(!t||typeof t!="object")&&(t={});const s=(e.subscriberData?.plan||"basic").toString().toLowerCase().trim();i(t);let u=e.subscriberData?{...e.subscriberData,plan:s,status:e.subscriberData.status||"active"}:null;if(h&&l&&!e.user.is_master&&l.toLowerCase()!==(e.user.email||"").toLowerCase()&&l.toLowerCase()!==(e.user.subscriber_email||"").toLowerCase())try{const b=await P.functions.invoke("checkSubscriptionStatus",{user_email:l});if(b.data?.subscriber){const C=b.data.subscriber,L=(C.plan||"basic").toString().toLowerCase().trim();u={...C,plan:L,status:C.status||"active"};let p=C.permissions||{};if(typeof p=="string")try{p=JSON.parse(p)}catch{p={}}(!p||typeof p!="object")&&(p={}),i(p),a.permission.log("âœ… [usePermission] Usando dados do assinante do slug:",l)}}catch(b){a.permission.warn("âš ï¸ [usePermission] Erro ao buscar dados do assinante do slug:",b)}f(u);let o=e.menuContext;h&&l&&!e.user.is_master&&(o={type:"subscriber",value:l},a.permission.log("âœ… [usePermission] Usando subscriberEmail do slug no menuContext:",l));const r={user:e.user,menuContext:o,permissions:t,isMaster:e.user.is_master===!0,subscriberData:e.user.is_master?null:u};d(r),a.permission.log("âœ… [usePermission] Contexto criado:",r.menuContext)}catch{a.permission.warn("âš ï¸ [usePermission] Endpoint /user/context nÃ£o disponÃ­vel, usando fallback");const s=await P.auth.me();if(!s){a.permission.warn("âš ï¸ [usePermission] UsuÃ¡rio nÃ£o encontrado"),i({}),y(null),f(null),d(null),m(!1);return}if(y(s),s.is_master===!0){const u={},o={email:s.email,plan:"master",status:"active",permissions:{}};i(u),f(o);const r=_(s,o,u);d(r)}else{let u;try{u=await P.functions.invoke("checkSubscriptionStatus",{user_email:s.email})}catch(o){a.permission.warn("âš ï¸ [usePermission] checkSubscriptionStatus falhou, usando contexto mÃ­nimo:",o?.message),u=null}if(u?.data?.subscriber){const o=u.data.subscriber;let r=o.permissions||{};if(typeof r=="string")try{r=JSON.parse(r)}catch{r={}}(!r||typeof r!="object")&&(r={}),i(r),f(o);const b=_(s,o,r);d(b)}else{const r={email:s.subscriber_email||s.email,plan:"basic",status:"active",permissions:{}};i({}),f(r);const b=_(s,r,{});d(b),a.permission.warn("âš ï¸ [usePermission] Usando contexto mÃ­nimo (checkSubscriptionStatus indisponÃ­vel)")}}}}catch(e){a.permission.error("Error loading permissions:",e),i({}),f(null),d(null),m(!1)}finally{m(!1)}},[h,l]);g.useEffect(()=>{x();const e=setInterval(x,300*1e3),c=()=>x();window.addEventListener("focus",c);const t=setTimeout(()=>{m(s=>s&&!1)},12e3);return()=>{clearInterval(e),window.removeEventListener("focus",c),clearTimeout(t)}},[x,h,l]);const E=S?.is_master===!0,U=e=>{if(E)return!0;if(n&&typeof n=="object"){const c=n[e];if(Array.isArray(c)&&c.length>0)return!0}return!1},w=(e,c)=>{if(E)return!0;if(!n||typeof n!="object")return!1;const t=n[e];return Array.isArray(t)&&t.includes(c)};return{permissions:n,loading:v,user:S,subscriberData:D,isMaster:E,hasModuleAccess:U,hasPermission:w,canCreate:e=>w(e,"create"),canUpdate:e=>w(e,"update"),canDelete:e=>w(e,"delete"),canView:e=>w(e,"view"),refresh:()=>{m(!0),x()},userContext:k,menuContext:k?.menuContext||null}}export{$ as u};
