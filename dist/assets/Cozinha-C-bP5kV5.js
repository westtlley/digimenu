import{r as o,j as e,B as C,P as O,u as q,g as _,L as $,z as F}from"./main-BRmc9wuQ.js";import{u as K}from"./useQuery-DECqmSjD.js";import{u as V}from"./useMutation-7mrcm5kq.js";import{u as Q}from"./useSlugContext-C_H0E5cf.js";import{u as G}from"./usePermission-iPsVutLm.js";import{B as M}from"./badge-0XfQUglg.js";import{C as H}from"./card-Ctp-7rs8.js";import{C as E}from"./chef-hat-BVOq19yV.js";import{B as Y}from"./bell-B_jl57AB.js";import{d as L,a as J,M as W,T as X}from"./differenceInMinutes-CxwK6Gwe.js";import{F as Z}from"./filter-B-ySBKey.js";import{C as ee}from"./clock-BVnf5BSk.js";import{A as B}from"./index-POiUmsPA.js";import{S as te}from"./shopping-bag-BPXgUy-7.js";import{T as se}from"./truck-BEX3wnhD.js";import{m as I}from"./proxy-UArsdzLI.js";import{U as ae}from"./user-DROTyYEO.js";import{M as ie}from"./map-pin-C1grN2RK.js";import{C as ne}from"./circle-check-big-BgD3Vilh.js";import{C as re}from"./circle-alert-BZWE3mVm.js";import{L as R}from"./log-out-CDSnoSZk.js";import"./base44Client-DNwoQjfp.js";import"./constants-CG7Neo-X.js";const ce={new:"bg-red-500",accepted:"bg-yellow-500",preparing:"bg-orange-500",ready:"bg-green-500"},le={new:"Novo",accepted:"Aceito",preparing:"Em Preparo",ready:"Pronto"},oe={delivery:se,pickup:te,dine_in:O};function de({order:t,prepTime:m}){const[d,j]=o.useState(0),[f,y]=o.useState(!1);if(o.useEffect(()=>{if(!t.accepted_at||!m)return;const l=setInterval(()=>{const h=L(new Date,new Date(t.accepted_at));j(h),y(h>m)},1e3);return()=>clearInterval(l)},[t.accepted_at,m]),!t.accepted_at||!m)return null;const c=m-d,u=c<=5&&c>0,x=c<=0;return e.jsxs("div",{className:`flex items-center gap-1 text-xs font-bold ${x?"text-red-600":u?"text-orange-600":"text-gray-600"}`,children:[e.jsx(X,{className:"w-3 h-3"}),x?e.jsxs("span",{className:"animate-pulse",children:["ATRASADO ",Math.abs(c),"min"]}):u?e.jsxs("span",{className:"animate-pulse",children:[c,"min"]}):e.jsxs("span",{children:[c,"min"]})]})}function me({order:t,onStatusChange:m,prepTime:d}){const[j,f]=o.useState(!1),y=oe[t.delivery_method]||O,c=t.accepted_at?L(new Date,new Date(t.accepted_at)):0,u=d&&c>d,x=d&&d-c<=5&&d-c>0;return e.jsx(I.div,{layout:!0,initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},className:`relative ${u?"ring-2 ring-red-500":x?"ring-2 ring-orange-500":""}`,children:e.jsxs(H,{className:`overflow-hidden transition-all ${u?"bg-red-50 dark:bg-red-900/20":x?"bg-orange-50 dark:bg-orange-900/20":"bg-white dark:bg-gray-800"}`,children:[e.jsx("div",{className:`p-3 ${ce[t.status]} text-white`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-bold text-lg",children:["#",t.order_code||t.id.slice(-6)]})]}),e.jsx(M,{variant:"secondary",className:"bg-white/20 text-white border-0",children:le[t.status]})]})}),e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm flex-wrap",children:[e.jsx(y,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600 dark:text-gray-400 capitalize",children:t.delivery_method==="delivery"?"Entrega":t.delivery_method==="pickup"?"Retirada":(t.delivery_method==="dine_in","Presencial")}),t.source&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-300",children:"•"}),e.jsx(M,{variant:"outline",className:"text-xs",children:t.source==="comanda"?"Comanda":t.source==="pdv"?"PDV":"Online"})]}),t.table_name&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-300",children:"•"}),e.jsxs("span",{className:"text-gray-600 dark:text-gray-400",children:["Mesa: ",t.table_name]})]}),t.customer_name&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-gray-300",children:"•"}),e.jsx(ae,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:t.customer_name})]})]}),t.status!=="new"&&t.accepted_at&&e.jsx(de,{order:t,prepTime:d||t.prep_time}),e.jsxs("div",{className:"space-y-1",children:[t.items?.slice(0,3).map((l,h)=>e.jsx("div",{className:"flex items-start justify-between text-sm",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("span",{className:"font-medium text-gray-900 dark:text-white",children:[l.quantity,"x ",l.name]}),l.observations&&e.jsxs("p",{className:"text-xs text-gray-500 italic mt-0.5",children:["Obs: ",l.observations]}),l.complements&&l.complements.length>0&&e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:l.complements.map(v=>v.name).join(", ")})]})},h)),t.items?.length>3&&e.jsxs("button",{onClick:()=>f(!j),className:"text-xs text-orange-600 hover:text-orange-700 font-medium",children:["+",t.items.length-3," itens"]})]}),e.jsx(B,{children:j&&e.jsx(I.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"space-y-1 pt-2 border-t",children:t.items?.slice(3).map((l,h)=>e.jsx("div",{className:"flex items-start justify-between text-sm",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("span",{className:"font-medium text-gray-900 dark:text-white",children:[l.quantity,"x ",l.name]}),l.observations&&e.jsxs("p",{className:"text-xs text-gray-500 italic mt-0.5",children:["Obs: ",l.observations]})]})},h))})}),t.observations&&e.jsx("div",{className:"pt-2 border-t",children:e.jsxs("p",{className:"text-xs text-gray-600 dark:text-gray-400 italic",children:[e.jsx("strong",{children:"Pedido:"})," ",t.observations]})}),t.delivery_method==="delivery"&&t.delivery_address&&e.jsxs("div",{className:"pt-2 border-t flex items-start gap-2 text-xs",children:[e.jsx(ie,{className:"w-3 h-3 text-gray-500 mt-0.5"}),e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:t.delivery_address})]}),e.jsxs("div",{className:"flex gap-2 pt-2 border-t",children:[t.status==="new"&&e.jsxs(C,{size:"sm",className:"flex-1 bg-green-600 hover:bg-green-700",onClick:()=>m(t,"accepted"),children:[e.jsx(ne,{className:"w-4 h-4 mr-1"}),"Aceitar"]}),t.status==="accepted"&&e.jsxs(C,{size:"sm",className:"flex-1 bg-orange-600 hover:bg-orange-700",onClick:()=>m(t,"preparing"),children:[e.jsx(E,{className:"w-4 h-4 mr-1"}),"Iniciar Preparo"]}),t.status==="preparing"&&e.jsxs(C,{size:"sm",className:"flex-1 bg-green-600 hover:bg-green-700",onClick:()=>m(t,"ready"),children:[e.jsx(O,{className:"w-4 h-4 mr-1"}),"Pronto"]})]})]})]})})}function xe({orders:t=[],onStatusChange:m,prepTime:d=30,isLoading:j=!1}){const[f,y]=o.useState("all"),[c,u]=o.useState("all"),[x,l]=o.useState(!1),[h,v]=o.useState(!0),[S,N]=o.useState(0),A=o.useMemo(()=>{let r=t;return f!=="all"&&(r=r.filter(i=>i.status===f)),c!=="all"&&(r=r.filter(i=>i.delivery_method===c)),r.sort((i,n)=>{if(i.status==="new"&&n.status!=="new")return-1;if(n.status==="new"&&i.status!=="new")return 1;if(i.status==="new"&&n.status==="new"){const D=i.created_date||i.created_at?new Date(i.created_date||i.created_at).getTime():0,z=n.created_date||n.created_at?new Date(n.created_date||n.created_at).getTime():0;return D-z}const g=i.prep_time||d,s=n.prep_time||d,p=i.accepted_at?new Date(i.accepted_at).getTime():0,a=n.accepted_at?new Date(n.accepted_at).getTime():0;if(p>0&&a>0){const D=new Date().getTime(),z=(D-p)/(1e3*60),U=(D-a)/(1e3*60),T=g-z,P=s-U;return T<0&&P>=0?-1:P<0&&T>=0?1:(T<0&&P<0,T-P)}const b=i.created_date||i.created_at?new Date(i.created_date||i.created_at).getTime():0,k=n.created_date||n.created_at?new Date(n.created_date||n.created_at).getTime():0;return b-k})},[t,f,c]),w=o.useMemo(()=>{const r=t.filter(a=>a.status==="new").length,i=t.filter(a=>a.status==="accepted").length,n=t.filter(a=>a.status==="preparing").length,g=t.filter(a=>a.status==="ready").length,s=t.filter(a=>a.ready_at&&a.accepted_at),p=s.length>0?s.reduce((a,b)=>{const k=L(new Date(b.ready_at),new Date(b.accepted_at));return a+k},0)/s.length:0;return{new:r,accepted:i,preparing:n,ready:g,total:t.length,avgPrepTime:Math.round(p)}},[t]);return o.useEffect(()=>{const r=t.filter(i=>i.status==="new").length;if(r>S&&h){const i=new Audio("/sounds/notification.mp3");i.volume=.5,i.play().catch(()=>{if(window.AudioContext||window.webkitAudioContext){const n=new(window.AudioContext||window.webkitAudioContext),g=n.createOscillator(),s=n.createGain();g.connect(s),s.connect(n.destination),g.frequency.value=800,g.type="sine",s.gain.setValueAtTime(.3,n.currentTime),s.gain.exponentialRampToValueAtTime(.01,n.currentTime+.5),g.start(n.currentTime),g.stop(n.currentTime+.5)}})}N(r)},[t.length,h,S]),o.useEffect(()=>{x?document.documentElement.requestFullscreen?.():document.exitFullscreen?.()},[x]),e.jsxs("div",{className:`${x?"fixed inset-0 z-50":""} bg-gray-100 dark:bg-gray-900`,children:[e.jsx("div",{className:"bg-orange-600 text-white shadow-lg sticky top-0 z-10",children:e.jsxs("div",{className:"px-4 py-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-6 h-6"}),e.jsx("h1",{className:"font-bold text-xl",children:"Kitchen Display"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{variant:"ghost",size:"sm",className:"text-white hover:bg-orange-500",onClick:()=>v(!h),children:e.jsx(Y,{className:`w-4 h-4 ${h?"":"opacity-50"}`})}),e.jsx(C,{variant:"ghost",size:"sm",className:"text-white hover:bg-orange-500",onClick:()=>l(!x),children:x?e.jsx(J,{className:"w-4 h-4"}):e.jsx(W,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-5 gap-2 text-center",children:[e.jsxs("div",{className:"bg-white/20 rounded p-2",children:[e.jsx("div",{className:"text-2xl font-bold",children:w.new}),e.jsx("div",{className:"text-xs opacity-90",children:"Novos"})]}),e.jsxs("div",{className:"bg-white/20 rounded p-2",children:[e.jsx("div",{className:"text-2xl font-bold",children:w.accepted}),e.jsx("div",{className:"text-xs opacity-90",children:"Aceitos"})]}),e.jsxs("div",{className:"bg-white/20 rounded p-2",children:[e.jsx("div",{className:"text-2xl font-bold",children:w.preparing}),e.jsx("div",{className:"text-xs opacity-90",children:"Preparando"})]}),e.jsxs("div",{className:"bg-white/20 rounded p-2",children:[e.jsx("div",{className:"text-2xl font-bold",children:w.ready}),e.jsx("div",{className:"text-xs opacity-90",children:"Prontos"})]}),e.jsxs("div",{className:"bg-white/20 rounded p-2",children:[e.jsx("div",{className:"text-2xl font-bold",children:w.avgPrepTime}),e.jsx("div",{className:"text-xs opacity-90",children:"Média (min)"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-3",children:[e.jsx(Z,{className:"w-4 h-4"}),e.jsxs("select",{value:f,onChange:r=>y(r.target.value),className:"bg-white/20 text-white border-white/30 rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"all",children:"Todos os Status"}),e.jsx("option",{value:"new",children:"Novos"}),e.jsx("option",{value:"accepted",children:"Aceitos"}),e.jsx("option",{value:"preparing",children:"Em Preparo"}),e.jsx("option",{value:"ready",children:"Prontos"})]}),e.jsxs("select",{value:c,onChange:r=>u(r.target.value),className:"bg-white/20 text-white border-white/30 rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"all",children:"Todos os Tipos"}),e.jsx("option",{value:"delivery",children:"Entrega"}),e.jsx("option",{value:"pickup",children:"Retirada"}),e.jsx("option",{value:"dine_in",children:"Presencial"})]})]})]})}),e.jsx("div",{className:"p-4",children:j?e.jsx("div",{className:"flex justify-center py-12",children:e.jsx(ee,{className:"w-8 h-8 animate-spin text-orange-500"})}):A.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(O,{className:"w-16 h-16 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Nenhum pedido encontrado"})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:e.jsx(B,{children:A.map(r=>e.jsx(me,{order:r,onStatusChange:m,prepTime:d||r.prep_time},r.id))})})})]})}function Fe(){const[t,m]=o.useState(null),[d,j]=o.useState(!0),[f,y]=o.useState(!1),[c,u]=o.useState({loading:!0,hasAccess:!1}),x=q(),{subscriberEmail:l,inSlugContext:h}=Q(),{subscriberData:v,isMaster:S}=G(),N=h&&t?.is_master&&l?l:void 0;o.useEffect(()=>{(async()=>{try{const s=await _.auth.me();if(m(s),!s){_.auth.redirectToLogin("/Cozinha");return}const p=s?.subscriber_email&&(s?.email||"").toLowerCase().trim()===(s?.subscriber_email||"").toLowerCase().trim(),a=s?.profile_role==="cozinha"||s?.is_master===!0||p;if(y(a),!a){j(!1);return}if(a&&!s?.is_master){const b=(v?.plan||"").toLowerCase(),k=b==="pro"||b==="ultra";u({loading:!1,hasAccess:k}),k||y(!1)}else s?.is_master?u({loading:!1,hasAccess:!0}):u({loading:!1,hasAccess:!1})}catch{_.auth.redirectToLogin("/Cozinha")}finally{j(!1)}})()},[v]);const{data:A=[],isLoading:w}=K({queryKey:["cozinhaOrders",N??"me"],queryFn:()=>_.entities.Order.list("-created_date",N?{as_subscriber:N}:{}),enabled:f,refetchInterval:8e3}),r=V({mutationFn:({id:s,updates:p})=>_.entities.Order.update(s,p,N?{as_subscriber:N}:{}),onSuccess:()=>{x.invalidateQueries({queryKey:["cozinhaOrders"]}),F.success("Status atualizado")},onError:s=>F.error(s?.message||"Erro ao atualizar")}),i=Array.isArray(A)?A.filter(s=>["new","accepted","preparing","ready"].includes(s.status)):[],n=30,g=(s,p)=>{const a={};p==="accepted"?(a.status="accepted",a.accepted_at=new Date().toISOString(),a.prep_time=s.prep_time||n):p==="preparing"?(a.status="preparing",a.preparing_at=new Date().toISOString()):p==="ready"&&(a.status="ready",a.ready_at=new Date().toISOString()),r.mutate({id:s.id,updates:a})};return d?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-100 dark:bg-gray-900",children:e.jsx($,{className:"w-8 h-8 animate-spin text-orange-500"})}):!f||c.loading===!1&&!c.hasAccess&&!S?e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4 bg-gray-100 dark:bg-gray-900",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 max-w-md text-center",children:[e.jsx(E,{className:"w-12 h-12 text-orange-500 mx-auto mb-3"}),e.jsx("h2",{className:"text-lg font-bold text-gray-900 dark:text-white",children:"Acesso restrito"}),!c.hasAccess&&!S?e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"w-8 h-8 text-orange-500 mx-auto mb-3"}),e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 mt-2",children:["O Kitchen Display System está disponível apenas nos planos ",e.jsx("strong",{children:"PRO"})," e ",e.jsx("strong",{children:"ULTRA"}),"."]}),e.jsxs("p",{className:"text-sm text-gray-400 dark:text-gray-500 mt-2",children:["Seu plano atual: ",e.jsx("strong",{children:(v?.plan||"Básico").toUpperCase()})]})]}):e.jsx("p",{className:"text-gray-500 dark:text-gray-400 mt-2",children:"Esta tela é apenas para o perfil Cozinha."}),e.jsxs(C,{onClick:()=>_.auth.logout(),className:"mt-4",variant:"outline",children:[e.jsx(R,{className:"w-4 h-4 mr-2"}),"Sair"]})]})}):e.jsxs("div",{className:"min-h-screen min-h-screen-mobile",children:[e.jsx(xe,{orders:i,onStatusChange:g,prepTime:n,isLoading:w}),e.jsx("div",{className:"fixed bottom-4 right-4 z-50",children:e.jsxs(C,{variant:"outline",size:"sm",className:"bg-white dark:bg-gray-800 shadow-lg",onClick:()=>_.auth.logout(),children:[e.jsx(R,{className:"w-4 h-4 mr-2"}),"Sair"]})})]})}export{Fe as default};
