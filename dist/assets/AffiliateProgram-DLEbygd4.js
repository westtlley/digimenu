import{r as m,u as ye,p as Be,z as A,j as e,B as g,P as De,C as F,T as Ee}from"./main-5wCJ0shd.js";import{b as p}from"./base44Client-BjweZdup.js";import{u as ae}from"./useQuery-TBRlwA9F.js";import{u as P}from"./useMutation-CfjUJVgq.js";import{I as v,L as o}from"./label-BGurCIwA.js";import{T as Fe}from"./textarea-BBItVPmi.js";import{D as re,a as ne,b as le,c as ce,f as Te}from"./dialog-BQt4A9EY.js";import{B as O}from"./badge-tC6tpDVj.js";import{S as je}from"./switch-CiXzU0WK.js";import{C as S,c as w,a as T,b as q}from"./card-co3zywKC.js";import{S as V,a as K,b as G,c as H,d as N}from"./select-D68HeZiV.js";import{uploadToCloudinary as qe}from"./cloudinaryUpload-vqCefYaz.js";import{u as be}from"./usePermission-CvwVjOfT.js";import{u as Ce,q as de,r as oe,s as L,t as u,v as me,w as x,x as Ae}from"./TablesTab-CaoLSTus.js";import{W as pe}from"./whatsappService-DTdPogZi.js";import{P as ue}from"./plus-DJfFeu4q.js";import{S as Me}from"./search-C1Oe3veH.js";import{T as Re,a as Pe,D as Qe}from"./thermometer-yqJr1fEX.js";import{b as ze}from"./EmptyState-DwIWL_NX.js";import{T as Le}from"./trash-2-CxXzmM5w.js";import{S as Ne}from"./shopping-cart-BukW6CqG.js";import{S as Oe}from"./differenceInCalendarDays-DQNRMz4Z.js";import{T as $e,a as Ue,b as ve,c as fe}from"./tabs-DLr74N5K.js";import{U as Ve}from"./users-BsPmyBXt.js";import{T as Ke}from"./trending-up-8OxCq5vE.js";import{D as _e}from"./dollar-sign-BdBkW913.js";import{C as Ge}from"./copy-DcaS5Ul6.js";import{S as He}from"./settings-CVkD5Rnm.js";const Je=f=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(f||0);function Cs(){const[f,n]=m.useState(null),[J,y]=m.useState(!1),[Q,k]=m.useState(!1),[j,z]=m.useState(null),[M,W]=m.useState(null),[b,B]=m.useState(""),[i,d]=m.useState("all"),[h,_]=m.useState(""),[l,c]=m.useState({name:"",description:"",image:"",price:"",category_id:"",beverage_type:"industrial",volume_ml:"",serving_temp:"cold",ean:"",sugar_free:!1,alcoholic:!1,caffeine:!1,dietary_tags:[],is_active:!0,is_highlight:!1,order:0}),D=ye();Be.useEffect(()=>{p.auth.me().then(n).catch(()=>{})},[]);const{menuContext:R,loading:xe}=be(),{data:ie=[],isLoading:Y}=Ce(),Z=m.useMemo(()=>(ie||[]).filter(s=>s.product_type==="beverage"),[ie]),{data:$=[],isLoading:he}=ae({queryKey:["beverageCategories",R?.type,R?.value],queryFn:async()=>{if(!R)return[];const s={};return R.type==="subscriber"&&R.value&&(s.as_subscriber=R.value),p.entities.BeverageCategory.list("order",s)},enabled:!!R}),X=xe||Y||he,te=P({mutationFn:s=>p.entities.Dish.create({...s,product_type:"beverage",subscriber_email:f?.subscriber_email||f?.email}),onSuccess:()=>{D.invalidateQueries({queryKey:["dishes"]}),A.success("Bebida criada!"),E()}}),a=P({mutationFn:({id:s,data:t})=>p.entities.Dish.update(s,t),onSuccess:()=>{D.invalidateQueries({queryKey:["dishes"]}),A.success("Bebida atualizada!"),E()}}),r=P({mutationFn:s=>p.entities.Dish.delete(s),onSuccess:()=>{D.invalidateQueries({queryKey:["dishes"]}),A.success("Bebida excluída!")}}),I=P({mutationFn:s=>p.entities.BeverageCategory.create({...s,subscriber_email:f?.subscriber_email||f?.email}),onSuccess:()=>{D.invalidateQueries({queryKey:["beverageCategories"]}),k(!1),_(""),A.success("Categoria criada!")}}),C=m.useMemo(()=>{let s=Z;return i!=="all"&&(s=s.filter(t=>t.category_id===i)),b&&(s=s.filter(t=>(t.name||"").toLowerCase().includes(b.toLowerCase()))),s},[Z,i,b]),E=()=>{y(!1),z(null),c({name:"",description:"",image:"",price:"",category_id:"",beverage_type:"industrial",volume_ml:"",serving_temp:"cold",ean:"",sugar_free:!1,alcoholic:!1,caffeine:!1,dietary_tags:[],is_active:!0,is_highlight:!1,order:0})};if(X)return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold flex items-center gap-2",children:[e.jsx(pe,{className:"w-6 h-6 text-cyan-500"}),"Bebidas"]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Carregando..."})]})}),e.jsx(S,{children:e.jsx(w,{className:"p-4",children:e.jsx("div",{className:"space-y-3",children:[1,2,3].map(s=>e.jsxs("div",{className:"flex items-center gap-4 p-3 rounded-lg border bg-gray-50/50 dark:bg-gray-800/30 animate-pulse",children:[e.jsx("div",{className:"w-14 h-14 rounded-lg bg-gray-200 dark:bg-gray-700"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/3"}),e.jsx("div",{className:"h-3 bg-gray-200 dark:bg-gray-700 rounded w-1/2"})]})]},s))})})})]});const U=(s=null)=>{s?(z(s),c({name:s.name||"",description:s.description||"",image:s.image||"",price:String(s.price??""),category_id:s.category_id||"",beverage_type:s.beverage_type||"industrial",volume_ml:String(s.volume_ml??""),serving_temp:s.serving_temp||"cold",ean:s.ean||"",sugar_free:!!s.sugar_free,alcoholic:!!s.alcoholic,caffeine:!!s.caffeine,dietary_tags:Array.isArray(s.dietary_tags)?s.dietary_tags:[],is_active:s.is_active!==!1,is_highlight:!!s.is_highlight,order:s.order??0})):(z(null),c({...l,category_id:$[0]?.id||"",order:Z.length})),y(!0)},Se=s=>{s.preventDefault();const t={...l,price:parseFloat(l.price)||0,volume_ml:parseInt(l.volume_ml,10)||null};j?a.mutate({id:j.id,data:t}):te.mutate(t)},we=async s=>{const t=s.target.files?.[0];if(!t)return;const ge=URL.createObjectURL(t);c(ee=>({...ee,image:ge})),A.loading("Enviando imagem...");try{const ee=await qe(t,"dishes");A.dismiss(),ee?(c(se=>({...se,image:ee})),A.success("Imagem enviada!")):(c(se=>({...se,image:""})),A.error("Erro no upload"))}catch{A.dismiss(),c(se=>({...se,image:""})),A.error("Falha ao enviar imagem")}},ke=s=>{c(t=>({...t,dietary_tags:t.dietary_tags.includes(s)?t.dietary_tags.filter(ge=>ge!==s):[...t.dietary_tags,s]}))},Ie=[{id:"vegano",label:"Vegano"},{id:"sem_lactose",label:"Sem lactose"},{id:"sem_gluten",label:"Sem glúten"},{id:"zero_acucar",label:"Zero açúcar"}];return e.jsxs("div",{className:"space-y-6 p-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold flex items-center gap-2",children:[e.jsx(pe,{className:"w-6 h-6 text-cyan-500"}),"Bebidas"]}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Cadastre refrigerantes, sucos, águas e outras bebidas"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>k(!0),children:[e.jsx(ue,{className:"w-4 h-4 mr-1"})," Categoria"]}),e.jsxs(g,{className:"bg-cyan-600 hover:bg-cyan-700",onClick:()=>U(),children:[e.jsx(ue,{className:"w-4 h-4 mr-2"})," Nova Bebida"]})]})]}),e.jsx(S,{children:e.jsxs(w,{className:"p-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mb-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Me,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx(v,{placeholder:"Buscar bebidas...",value:b,onChange:s=>B(s.target.value),className:"pl-9"})]}),e.jsxs(V,{value:i,onValueChange:d,children:[e.jsx(K,{className:"w-full sm:w-[200px]",children:e.jsx(G,{placeholder:"Categoria"})}),e.jsxs(H,{children:[e.jsx(N,{value:"all",children:"Todas"}),$.map(s=>e.jsx(N,{value:s.id,children:s.name},s.id))]})]})]}),e.jsx("div",{className:"grid gap-3",children:C.map(s=>e.jsxs("div",{className:"flex items-center gap-4 p-3 rounded-lg border bg-gray-50/50 dark:bg-gray-800/30",children:[s.image&&e.jsx("img",{src:s.image,alt:"",className:"w-14 h-14 rounded-lg object-cover"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:"font-semibold",children:s.name}),s.volume_ml&&e.jsxs(O,{variant:"outline",className:"text-xs",children:[s.volume_ml,"ml"]}),s.beverage_type==="natural"&&e.jsx(O,{className:"bg-green-100 text-green-800 text-xs",children:"Natural"}),s.serving_temp==="cold"&&e.jsx(Re,{className:"w-4 h-4 text-blue-500"}),s.serving_temp==="hot"&&e.jsx(Pe,{className:"w-4 h-4 text-orange-500"})]}),e.jsxs("p",{className:"text-sm text-gray-500 truncate",children:[$.find(t=>t.id===s.category_id)?.name," · ",Je(s.price)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(je,{checked:s.is_active!==!1,onCheckedChange:t=>a.mutate({id:s.id,data:{...s,is_active:t}})}),e.jsx(g,{variant:"ghost",size:"icon",onClick:()=>U(s),children:e.jsx(ze,{className:"w-4 h-4"})}),e.jsx(g,{variant:"ghost",size:"icon",className:"text-red-500",onClick:()=>confirm("Excluir?")&&r.mutate(s.id),children:e.jsx(Le,{className:"w-4 h-4"})})]})]},s.id))}),C.length===0&&e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(pe,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"Nenhuma bebida cadastrada"}),e.jsx(g,{variant:"outline",className:"mt-3",onClick:()=>U(),children:"Cadastrar primeira bebida"})]})]})}),e.jsx(re,{open:J,onOpenChange:s=>!s&&E(),children:e.jsxs(ne,{className:"sm:max-w-2xl max-w-[95vw] max-h-[90vh] overflow-y-auto",children:[e.jsx(le,{children:e.jsx(ce,{children:j?"Editar Bebida":"Nova Bebida"})}),e.jsxs("form",{onSubmit:Se,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Nome *"}),e.jsx(v,{value:l.name,onChange:s=>c(t=>({...t,name:s.target.value})),placeholder:"Ex: Refrigerante Coca-Cola",required:!0})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Categoria"}),e.jsxs(V,{value:l.category_id,onValueChange:s=>c(t=>({...t,category_id:s})),children:[e.jsx(K,{children:e.jsx(G,{placeholder:"Selecione"})}),e.jsx(H,{children:$.map(s=>e.jsx(N,{value:s.id,children:s.name},s.id))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Tipo"}),e.jsxs(V,{value:l.beverage_type,onValueChange:s=>c(t=>({...t,beverage_type:s})),children:[e.jsx(K,{children:e.jsx(G,{})}),e.jsxs(H,{children:[e.jsxs(N,{value:"industrial",children:[e.jsx(De,{className:"w-4 h-4 mr-2 inline"})," Industrializado"]}),e.jsxs(N,{value:"natural",children:[e.jsx(Qe,{className:"w-4 h-4 mr-2 inline"})," Natural"]})]})]})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Volume (ml)"}),e.jsx(v,{type:"number",min:"1",value:l.volume_ml,onChange:s=>c(t=>({...t,volume_ml:s.target.value})),placeholder:"350"})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Temperatura"}),e.jsxs(V,{value:l.serving_temp,onValueChange:s=>c(t=>({...t,serving_temp:s})),children:[e.jsx(K,{children:e.jsx(G,{})}),e.jsxs(H,{children:[e.jsx(N,{value:"cold",children:"Gelado"}),e.jsx(N,{value:"room",children:"Ambiente"}),e.jsx(N,{value:"hot",children:"Quente"})]})]})]}),e.jsxs("div",{children:[e.jsx(o,{children:"EAN (código de barras)"}),e.jsx(v,{value:l.ean,onChange:s=>c(t=>({...t,ean:s.target.value})),placeholder:"7891234567890"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Preço *"}),e.jsx(v,{type:"number",step:"0.01",value:l.price,onChange:s=>c(t=>({...t,price:s.target.value})),placeholder:"5.00",required:!0})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Imagem da bebida"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("input",{type:"file",accept:"image/*",className:"hidden",id:"beverage-image-upload",onChange:we}),e.jsx("label",{htmlFor:"beverage-image-upload",className:"px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 cursor-pointer text-sm transition-colors",children:l.image?"Alterar Foto":"Adicionar Foto"}),l.image&&e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:l.image,alt:"Preview",className:"w-16 h-16 rounded object-cover border-2 border-gray-200"}),e.jsx("button",{type:"button",onClick:()=>c(s=>({...s,image:""})),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-600",children:"×"})]})]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium w-full",children:"Características"}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:l.sugar_free,onChange:s=>c(t=>({...t,sugar_free:s.target.checked}))})," Sem açúcar"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:l.alcoholic,onChange:s=>c(t=>({...t,alcoholic:s.target.checked}))})," Alcoólico"]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:l.caffeine,onChange:s=>c(t=>({...t,caffeine:s.target.checked}))})," Cafeína"]}),Ie.map(s=>e.jsx(O,{variant:l.dietary_tags.includes(s.id)?"default":"outline",className:"cursor-pointer",onClick:()=>ke(s.id),children:s.label},s.id))]}),e.jsxs("div",{children:[e.jsx(o,{children:"Descrição"}),e.jsx(Fe,{value:l.description,onChange:s=>c(t=>({...t,description:s.target.value})),rows:2,placeholder:"Descrição opcional"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded",children:[e.jsx(o,{children:"Ativo"}),e.jsx(je,{checked:l.is_active,onCheckedChange:s=>c(t=>({...t,is_active:s}))})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded",children:[e.jsx(o,{children:"Destacar no cardápio"}),e.jsx(je,{checked:l.is_highlight,onCheckedChange:s=>c(t=>({...t,is_highlight:s}))})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(g,{type:"button",variant:"outline",onClick:E,className:"flex-1",children:"Cancelar"}),e.jsx(g,{type:"submit",className:"flex-1 bg-cyan-600 hover:bg-cyan-700",children:j?"Salvar":"Criar"})]})]})]})}),e.jsx(re,{open:Q,onOpenChange:k,children:e.jsxs(ne,{children:[e.jsx(le,{children:e.jsx(ce,{children:"Nova Categoria de Bebidas"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Nome"}),e.jsx(v,{value:h,onChange:s=>_(s.target.value),placeholder:"Ex: Refrigerantes, Sucos, Águas"})]}),e.jsx(g,{onClick:()=>h.trim()&&I.mutate({name:h.trim(),order:$.length}),className:"w-full",children:"Criar"})]})]})})]})}function Ss(){const f=ye(),{menuContext:n}=be(),[J,y]=m.useState(!1),[Q,k]=m.useState(!1),[j,z]=m.useState(null),[M,W]=m.useState(null),[b,B]=m.useState({name:"",unit:"unidade",current_stock:0,min_stock:5,cost_per_unit:0,expiration_date:null}),[i,d]=m.useState({ingredient_id:"",quantity:1}),{data:h=[]}=ae({queryKey:["ingredients",n?.type,n?.value],queryFn:async()=>{if(!n)return[];const a={};return n.type==="subscriber"&&n.value&&(a.as_subscriber=n.value),p.entities.Ingredient.list(null,a)},enabled:!!n}),{data:_=[]}=Ce(),{data:l=[]}=ae({queryKey:["dishIngredients",n?.type,n?.value],queryFn:async()=>{if(!n)return[];const a={};return n.type==="subscriber"&&n.value&&(a.as_subscriber=n.value),p.entities.DishIngredient.list(null,a)},enabled:!!n}),c=m.useMemo(()=>{const a={};return h.forEach(r=>{a[r.id]={...r,available:r.current_stock||0,reserved:0,lowStock:(r.current_stock||0)<=(r.min_stock||5)}}),a},[h]),D=m.useMemo(()=>h.filter(a=>(a.current_stock||0)<=(a.min_stock||5)),[h]);m.useMemo(()=>{const a=[];return D.forEach(r=>{const I=l.filter(C=>C.ingredient_id===r.id).map(C=>{const E=_.find(U=>U.id===C.dish_id);return E?{...E,requiredQuantity:C.quantity}:null}).filter(Boolean);a.push(...I)}),a},[D,l,_]);const R=P({mutationFn:async a=>p.entities.Ingredient.create(a),onSuccess:()=>{f.invalidateQueries(["ingredients"]),F.success("Ingrediente criado com sucesso!"),y(!1),Y()},onError:a=>{F.error("Erro ao criar ingrediente: "+(a.message||"Erro desconhecido"))}}),xe=P({mutationFn:async({id:a,data:r})=>p.entities.Ingredient.update(a,r),onSuccess:()=>{f.invalidateQueries(["ingredients"]),F.success("Ingrediente atualizado com sucesso!"),y(!1),Y()},onError:a=>{F.error("Erro ao atualizar ingrediente: "+(a.message||"Erro desconhecido"))}});P({mutationFn:async a=>p.entities.Ingredient.delete(a),onSuccess:()=>{f.invalidateQueries(["ingredients"]),F.error("Ingrediente deletado com sucesso!")},onError:a=>{F.error("Erro ao deletar ingrediente: "+(a.message||"Erro desconhecido"))}});const ie=P({mutationFn:async a=>p.entities.DishIngredient.create({...a,dish_id:M.id}),onSuccess:()=>{f.invalidateQueries(["dishIngredients"]),F.success("Ingrediente adicionado ao prato!"),k(!1),Z()},onError:a=>{F.error("Erro ao adicionar ingrediente: "+(a.message||"Erro desconhecido"))}}),Y=()=>{B({name:"",unit:"unidade",current_stock:0,min_stock:5,cost_per_unit:0,expiration_date:null}),z(null)},Z=()=>{d({ingredient_id:"",quantity:1})},$=a=>{z(a),B({name:a.name||"",unit:a.unit||"unidade",current_stock:a.current_stock||0,min_stock:a.min_stock||5,cost_per_unit:a.cost_per_unit||0,expiration_date:a.expiration_date||null}),y(!0)},he=a=>{a.preventDefault(),j?xe.mutate({id:j.id,data:b}):R.mutate(b)},X=(a,r,I)=>{p.entities.StockMovement.create({ingredient_id:a,type:r,quantity:I,created_at:new Date().toISOString()}).then(()=>{const E=(h.find(U=>U.id===a).current_stock||0)+I;p.entities.Ingredient.update(a,{current_stock:E}).then(()=>{f.invalidateQueries(["ingredients"]),F.success("Estoque atualizado!")})})},te=m.useMemo(()=>D.map(a=>({...a,suggestedQuantity:(a.min_stock||5)*3,estimatedCost:(a.min_stock||5)*3*(a.cost_per_unit||0)})),[D]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Gestão de Estoque"}),e.jsx("p",{className:"text-gray-500",children:"Rastreie ingredientes e gerencie estoque"})]}),e.jsxs(re,{open:J,onOpenChange:y,children:[e.jsx(Te,{asChild:!0,children:e.jsxs(g,{onClick:Y,children:[e.jsx(ue,{className:"w-4 h-4 mr-2"}),"Novo Ingrediente"]})}),e.jsxs(ne,{className:"sm:max-w-md max-w-[95vw]",children:[e.jsx(le,{children:e.jsx(ce,{children:j?"Editar Ingrediente":"Novo Ingrediente"})}),e.jsxs("form",{onSubmit:he,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Nome *"}),e.jsx(v,{value:b.name,onChange:a=>B(r=>({...r,name:a.target.value})),required:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Unidade"}),e.jsxs(V,{value:b.unit,onValueChange:a=>B(r=>({...r,unit:a})),children:[e.jsx(K,{children:e.jsx(G,{})}),e.jsxs(H,{children:[e.jsx(N,{value:"unidade",children:"Unidade"}),e.jsx(N,{value:"kg",children:"Quilograma"}),e.jsx(N,{value:"g",children:"Grama"}),e.jsx(N,{value:"l",children:"Litro"}),e.jsx(N,{value:"ml",children:"Mililitro"})]})]})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Estoque Atual"}),e.jsx(v,{type:"number",value:b.current_stock,onChange:a=>B(r=>({...r,current_stock:parseFloat(a.target.value)||0})),min:"0"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Estoque Mínimo"}),e.jsx(v,{type:"number",value:b.min_stock,onChange:a=>B(r=>({...r,min_stock:parseFloat(a.target.value)||5})),min:"0"})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Custo por Unidade (R$)"}),e.jsx(v,{type:"number",step:"0.01",value:b.cost_per_unit,onChange:a=>B(r=>({...r,cost_per_unit:parseFloat(a.target.value)||0})),min:"0"})]})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(g,{type:"button",variant:"outline",onClick:()=>y(!1),children:"Cancelar"}),e.jsx(g,{type:"submit",children:j?"Atualizar":"Criar"})]})]})]})]})]}),D.length>0&&e.jsxs(S,{className:"border-red-200 bg-red-50",children:[e.jsx(T,{children:e.jsxs(q,{className:"flex items-center gap-2 text-red-700",children:[e.jsx(Ee,{className:"w-5 h-5"}),"Alertas de Estoque Baixo"]})}),e.jsx(w,{children:e.jsx("div",{className:"space-y-2",children:D.map(a=>e.jsxs("div",{className:"flex justify-between items-center p-2 bg-white rounded",children:[e.jsxs("div",{children:[e.jsx("strong",{children:a.name}),e.jsxs("span",{className:"text-sm text-gray-500 ml-2",children:["Estoque: ",a.current_stock," ",a.unit," (Mínimo: ",a.min_stock,")"]})]}),e.jsxs(g,{size:"sm",onClick:()=>X(a.id,"entry",a.min_stock*3),children:[e.jsx(Ne,{className:"w-4 h-4 mr-1"}),"Comprar"]})]},a.id))})})]}),te.length>0&&e.jsxs(S,{children:[e.jsx(T,{children:e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"w-5 h-5"}),"Sugestões de Compra"]})}),e.jsx(w,{children:e.jsxs(de,{children:[e.jsx(oe,{children:e.jsxs(L,{children:[e.jsx(u,{children:"Ingrediente"}),e.jsx(u,{children:"Quantidade Sugerida"}),e.jsx(u,{children:"Custo Estimado"}),e.jsx(u,{children:"Ação"})]})}),e.jsx(me,{children:te.map(a=>e.jsxs(L,{children:[e.jsx(x,{children:a.name}),e.jsxs(x,{children:[a.suggestedQuantity," ",a.unit]}),e.jsxs(x,{children:["R$ ",a.estimatedCost.toFixed(2)]}),e.jsx(x,{children:e.jsx(g,{size:"sm",onClick:()=>X(a.id,"entry",a.suggestedQuantity),children:"Adicionar ao Estoque"})})]},a.id))})]})})]}),e.jsxs(S,{children:[e.jsx(T,{children:e.jsx(q,{children:"Ingredientes"})}),e.jsx(w,{children:e.jsxs(de,{children:[e.jsx(oe,{children:e.jsxs(L,{children:[e.jsx(u,{children:"Nome"}),e.jsx(u,{children:"Estoque"}),e.jsx(u,{children:"Mínimo"}),e.jsx(u,{children:"Status"}),e.jsx(u,{children:"Ações"})]})}),e.jsx(me,{children:h.map(a=>{const r=c[a.id];return e.jsxs(L,{children:[e.jsx(x,{children:a.name}),e.jsxs(x,{children:[a.current_stock||0," ",a.unit]}),e.jsxs(x,{children:[a.min_stock||5," ",a.unit]}),e.jsx(x,{children:r?.lowStock?e.jsx(O,{variant:"destructive",children:"Estoque Baixo"}):e.jsx(O,{variant:"default",children:"OK"})}),e.jsx(x,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{size:"sm",variant:"outline",onClick:()=>$(a),children:e.jsx(Oe,{className:"w-4 h-4"})}),e.jsx(g,{size:"sm",variant:"outline",onClick:()=>X(a.id,"entry",10),children:"+10"})]})})]},a.id)})})]})})]}),e.jsxs(S,{children:[e.jsx(T,{children:e.jsx(q,{children:"Ingredientes por Prato"})}),e.jsx(w,{children:e.jsx("div",{className:"space-y-4",children:_.map(a=>{const r=l.filter(I=>I.dish_id===a.id);return e.jsxs("div",{className:"border rounded p-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("strong",{children:a.name}),e.jsxs(g,{size:"sm",onClick:()=>{W(a),k(!0)},children:[e.jsx(ue,{className:"w-4 h-4 mr-1"}),"Adicionar Ingrediente"]})]}),r.length>0?e.jsx("ul",{className:"list-disc list-inside space-y-1",children:r.map(I=>{const C=h.find(E=>E.id===I.ingredient_id);return C?e.jsxs("li",{children:[C.name," - ",I.quantity," ",C.unit,c[C.id]?.lowStock&&e.jsx(O,{variant:"destructive",className:"ml-2",children:"Estoque Baixo"})]},I.id):null})}):e.jsx("p",{className:"text-gray-500 text-sm",children:"Nenhum ingrediente cadastrado"})]},a.id)})})})]}),e.jsx(re,{open:Q,onOpenChange:k,children:e.jsxs(ne,{children:[e.jsx(le,{children:e.jsxs(ce,{children:["Adicionar Ingrediente - ",M?.name]})}),e.jsxs("form",{onSubmit:a=>{a.preventDefault(),ie.mutate(i)},className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Ingrediente"}),e.jsxs(V,{value:i.ingredient_id,onValueChange:a=>d(r=>({...r,ingredient_id:a})),children:[e.jsx(K,{children:e.jsx(G,{placeholder:"Selecione um ingrediente"})}),e.jsx(H,{children:h.map(a=>e.jsxs(N,{value:a.id,children:[a.name," (",a.unit,")"]},a.id))})]})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Quantidade"}),e.jsx(v,{type:"number",value:i.quantity,onChange:a=>d(r=>({...r,quantity:parseFloat(a.target.value)||1})),min:"0.01",step:"0.01"})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(g,{type:"button",variant:"outline",onClick:()=>k(!1),children:"Cancelar"}),e.jsx(g,{type:"submit",children:"Adicionar"})]})]})]})})]})}function ws(){const f=ye(),{menuContext:n}=be(),J=()=>{const i=localStorage.getItem("affiliateSettings");if(i)try{return JSON.parse(i)}catch{}return{referrerBonus:20,referredBonus:10,commissionRate:10,minPayout:50}},[y,Q]=m.useState(J()),{data:k=[]}=ae({queryKey:["affiliates",n?.type,n?.value],queryFn:async()=>{if(!n)return[];const i={};return n.type==="subscriber"&&n.value&&(i.as_subscriber=n.value),p.entities.Affiliate.list(null,i)},enabled:!!n}),{data:j=[]}=ae({queryKey:["referrals",n?.type,n?.value],queryFn:async()=>{if(!n)return[];const i={};return n.type==="subscriber"&&n.value&&(i.as_subscriber=n.value),p.entities.Referral.list(null,i)},enabled:!!n}),{data:z=[]}=Ae({orderBy:"-created_date"}),M={totalAffiliates:k.length,totalReferrals:j.length,activeReferrals:j.filter(i=>i.status==="completed").length,totalCommissions:j.filter(i=>i.status==="completed").reduce((i,d)=>i+(d.commission||0),0),pendingPayouts:j.filter(i=>i.status==="completed"&&!i.paid).reduce((i,d)=>i+(d.commission||0),0)},W=P({mutationFn:async i=>(localStorage.setItem("affiliateSettings",JSON.stringify(i)),{success:!0,settings:i}),onSuccess:()=>{f.invalidateQueries(["affiliateSettings"]),F.success("Configurações atualizadas!")}}),b=i=>{const d=window.location.origin,h=localStorage.getItem("currentSlug")||"";return`${d}/cardapio?ref=${i}${h?`&slug=${h}`:""}`},B=i=>{navigator.clipboard.writeText(i),F.success("Link copiado!")};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Programa de Afiliados"}),e.jsx("p",{className:"text-gray-500",children:"Gerencie indicações e comissões"})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(S,{children:[e.jsx(T,{className:"pb-2",children:e.jsxs(q,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Ve,{className:"w-4 h-4 text-blue-500"}),"Total de Afiliados"]})}),e.jsx(w,{children:e.jsx("div",{className:"text-2xl font-bold",children:M.totalAffiliates})})]}),e.jsxs(S,{children:[e.jsx(T,{className:"pb-2",children:e.jsxs(q,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Ke,{className:"w-4 h-4 text-green-500"}),"Indicações Ativas"]})}),e.jsxs(w,{children:[e.jsx("div",{className:"text-2xl font-bold",children:M.activeReferrals}),e.jsxs("p",{className:"text-xs text-gray-500",children:[M.totalReferrals," total"]})]})]}),e.jsxs(S,{children:[e.jsx(T,{className:"pb-2",children:e.jsxs(q,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(_e,{className:"w-4 h-4 text-yellow-500"}),"Comissões Totais"]})}),e.jsx(w,{children:e.jsxs("div",{className:"text-2xl font-bold",children:["R$ ",M.totalCommissions.toFixed(2)]})})]}),e.jsxs(S,{children:[e.jsx(T,{className:"pb-2",children:e.jsxs(q,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(_e,{className:"w-4 h-4 text-orange-500"}),"Pendentes"]})}),e.jsx(w,{children:e.jsxs("div",{className:"text-2xl font-bold",children:["R$ ",M.pendingPayouts.toFixed(2)]})})]})]}),e.jsxs($e,{defaultValue:"affiliates",className:"space-y-4",children:[e.jsxs(Ue,{children:[e.jsx(ve,{value:"affiliates",children:"Afiliados"}),e.jsx(ve,{value:"referrals",children:"Indicações"}),e.jsx(ve,{value:"settings",children:"Configurações"})]}),e.jsx(fe,{value:"affiliates",children:e.jsxs(S,{children:[e.jsx(T,{children:e.jsx(q,{children:"Afiliados Cadastrados"})}),e.jsx(w,{children:e.jsxs(de,{children:[e.jsx(oe,{children:e.jsxs(L,{children:[e.jsx(u,{children:"Nome"}),e.jsx(u,{children:"Email"}),e.jsx(u,{children:"Link de Indicação"}),e.jsx(u,{children:"Indicações"}),e.jsx(u,{children:"Comissões"}),e.jsx(u,{children:"Status"})]})}),e.jsx(me,{children:k.map(i=>{const d=j.filter(l=>l.affiliate_id===i.id),h=d.filter(l=>l.status==="completed").reduce((l,c)=>l+(c.commission||0),0),_=b(i.id);return e.jsxs(L,{children:[e.jsx(x,{children:i.name||i.email}),e.jsx(x,{children:i.email}),e.jsx(x,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{value:_,readOnly:!0,className:"w-64 text-xs"}),e.jsx(g,{size:"sm",variant:"outline",onClick:()=>B(_),children:e.jsx(Ge,{className:"w-4 h-4"})})]})}),e.jsx(x,{children:d.length}),e.jsxs(x,{children:["R$ ",h.toFixed(2)]}),e.jsx(x,{children:e.jsx(O,{variant:i.status==="active"?"default":"secondary",children:i.status==="active"?"Ativo":"Inativo"})})]},i.id)})})]})})]})}),e.jsx(fe,{value:"referrals",children:e.jsxs(S,{children:[e.jsx(T,{children:e.jsx(q,{children:"Indicações e Comissões"})}),e.jsx(w,{children:e.jsxs(de,{children:[e.jsx(oe,{children:e.jsxs(L,{children:[e.jsx(u,{children:"Afiliado"}),e.jsx(u,{children:"Cliente Indicado"}),e.jsx(u,{children:"Pedido"}),e.jsx(u,{children:"Valor"}),e.jsx(u,{children:"Comissão"}),e.jsx(u,{children:"Status"})]})}),e.jsx(me,{children:j.map(i=>{const d=z.find(_=>_.id===i.order_id),h=k.find(_=>_.id===i.affiliate_id);return e.jsxs(L,{children:[e.jsx(x,{children:h?.name||h?.email||"N/A"}),e.jsx(x,{children:i.referred_email||i.referred_name||"N/A"}),e.jsxs(x,{children:["#",d?.order_code||i.order_id]}),e.jsxs(x,{children:["R$ ",d?.total?.toFixed(2)||"0,00"]}),e.jsxs(x,{children:["R$ ",i.commission?.toFixed(2)||"0,00"]}),e.jsx(x,{children:e.jsx(O,{variant:i.status==="completed"?"default":i.status==="pending"?"secondary":"destructive",children:i.status==="completed"?"Concluído":i.status==="pending"?"Pendente":"Cancelado"})})]},i.id)})})]})})]})}),e.jsx(fe,{value:"settings",children:e.jsxs(S,{children:[e.jsx(T,{children:e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(He,{className:"w-5 h-5"}),"Configurações do Programa"]})}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{children:"Bônus para Quem Indica (%)"}),e.jsx(v,{type:"number",value:y.referrerBonus,onChange:i=>Q(d=>({...d,referrerBonus:parseFloat(i.target.value)||0}))}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Desconto no próximo pedido"})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Bônus para Indicado (R$)"}),e.jsx(v,{type:"number",value:y.referredBonus,onChange:i=>Q(d=>({...d,referredBonus:parseFloat(i.target.value)||0}))}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Desconto na primeira compra"})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Taxa de Comissão (%)"}),e.jsx(v,{type:"number",value:y.commissionRate,onChange:i=>Q(d=>({...d,commissionRate:parseFloat(i.target.value)||0}))}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"% sobre cada venda"})]}),e.jsxs("div",{children:[e.jsx(o,{children:"Valor Mínimo para Saque (R$)"}),e.jsx(v,{type:"number",value:y.minPayout,onChange:i=>Q(d=>({...d,minPayout:parseFloat(i.target.value)||0}))}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Mínimo para solicitar pagamento"})]})]}),e.jsx(g,{onClick:()=>W.mutate(y),disabled:W.isLoading,children:"Salvar Configurações"})]})]})})]})]})}export{ws as A,Cs as B,Ss as I};
